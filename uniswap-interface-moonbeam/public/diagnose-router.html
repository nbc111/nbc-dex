<!DOCTYPE html>
<html>
<head>
    <title>Router è¯Šæ–­å·¥å…·</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
        }
        button:hover { background: #00cc00; }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
    </style>
</head>
<body>
    <h1>ğŸ” Router æ·±åº¦è¯Šæ–­</h1>
    
    <div class="section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <button onclick="test1()">1. åŸºç¡€é…ç½®æ£€æŸ¥</button>
        <button onclick="test2()">2. æµ‹è¯•ç®€å•å‡½æ•°</button>
        <button onclick="test3()">3. æµ‹è¯• getAmountsOut</button>
        <button onclick="test4()">4. æµ‹è¯• addLiquidity (ä¼°ç®—)</button>
        <button onclick="test5()">5. å¯¹æ¯” Pair ç›´æ¥è°ƒç”¨</button>
        <button onclick="runAll()" style="background: #ff6600;">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
        <button onclick="clearOutput()" style="background: #666;">æ¸…é™¤</button>
    </div>

    <div class="section">
        <h2>è¯Šæ–­ç»“æœ</h2>
        <pre id="output"></pre>
    </div>

    <script>
        const ROUTER = '0x3d53f590c82a61f85e6B1f0813e509AEAA0b4991';
        const FACTORY = '0xf0616CCDa274b6DbFa645d70f8Dc0f617707E793';
        const BTC = '0x5EaA2c6ae3bFf47D2188B64F743Ec777733a80ac';
        const ETH = '0x934EbeB6D7D3821B604A5D10F80619d5bcBe49C3';
        const PAIR = '0x66902e8974efa668ebdeb692dc9c60a2dda01ff6';
        
        let output = document.getElementById('output');
        
        function clearOutput() {
            output.textContent = '';
        }
        
        function log(msg, type = 'info') {
            const colors = { success: '#00ff00', error: '#ff0000', warning: '#ffaa00', info: '#00aaff' };
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<span style="color: ${colors[type]}">[${time}] ${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        async function test1() {
            log('=== æµ‹è¯• 1: åŸºç¡€é…ç½®æ£€æŸ¥ ===\n', 'info');
            
            try {
                // æ£€æŸ¥ factory()
                const factoryData = '0xc45a0155';
                const factoryResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: ROUTER, data: factoryData }, 'latest']
                });
                const factoryAddr = '0x' + factoryResult.slice(-40);
                log(`factory(): ${factoryAddr}`, factoryAddr.toLowerCase() === FACTORY.toLowerCase() ? 'success' : 'error');
                
                // æ£€æŸ¥ WETH()
                const wethData = '0xad5c4648';
                const wethResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: ROUTER, data: wethData }, 'latest']
                });
                const wethAddr = '0x' + wethResult.slice(-40);
                log(`WETH(): ${wethAddr}`, wethAddr.toLowerCase() === WNBC.toLowerCase() ? 'success' : 'error');
                
                log('âœ… åŸºç¡€é…ç½®æ­£å¸¸\n', 'success');
                return true;
            } catch (err) {
                log(`âŒ é”™è¯¯: ${err.message}\n`, 'error');
                return false;
            }
        }
        
        async function test2() {
            log('=== æµ‹è¯• 2: ç®€å•å‡½æ•°è°ƒç”¨ ===\n', 'info');
            
            try {
                // æµ‹è¯• quote(uint amountA, uint reserveA, uint reserveB)
                log('æµ‹è¯• quote() å‡½æ•°...', 'info');
                const quoteData = '0xad615dec' + 
                    '0000000000000000000000000000000000000000000000000000000005f5e100' + // 1e8 (1 BTC)
                    '0000000000000000000000000000000000000000000000000000000003b9aca00' + // 1e9 (10 BTC in reserves)
                    '0000000000000000000000000000000000000000000000033b2e3c9fd0803ce8'; // 60e18 (60 ETH in reserves)
                
                const quoteResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: ROUTER, data: quoteData }, 'latest']
                });
                
                const quotedAmount = BigInt(quoteResult);
                log(`   è¾“å…¥: 1 BTC (1e8)`, 'info');
                log(`   è¾“å‡º: ${quotedAmount.toString()} wei (${Number(quotedAmount) / 1e18} ETH)`, 'success');
                log(`   âœ… quote() å‡½æ•°æ­£å¸¸å·¥ä½œ\n`, 'success');
                return true;
            } catch (err) {
                log(`   âŒ quote() å¤±è´¥: ${err.message}\n`, 'error');
                return false;
            }
        }
        
        async function test3() {
            log('=== æµ‹è¯• 3: getAmountsOut ===\n', 'info');
            
            try {
                const amountIn = 1n * 10n**8n; // 1 BTC
                
                log('æ–¹æ³• 1: æ ‡å‡† ABI ç¼–ç ', 'info');
                const data1 = '0xd06ca61f' + 
                    amountIn.toString(16).padStart(64, '0') +
                    '0000000000000000000000000000000000000000000000000000000000000040' +
                    '0000000000000000000000000000000000000000000000000000000000000002' +
                    BTC.slice(2).padStart(64, '0') +
                    ETH.slice(2).padStart(64, '0');
                
                log(`   è°ƒç”¨æ•°æ®: ${data1.substring(0, 100)}...`, 'info');
                
                try {
                    const result1 = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: ROUTER, data: data1 }, 'latest']
                    });
                    log(`   âœ… æˆåŠŸ! è¿”å›: ${result1.substring(0, 100)}...`, 'success');
                    
                    // è§£æç»“æœ
                    const amountOut = BigInt('0x' + result1.slice(130, 194));
                    log(`   è¾“å‡ºé‡: ${Number(amountOut) / 1e18} ETH\n`, 'success');
                    return true;
                } catch (err) {
                    log(`   âŒ å¤±è´¥: ${err.message}`, 'error');
                    
                    // å°è¯•è·å–è¯¦ç»†é”™è¯¯
                    if (err.data) {
                        log(`   é”™è¯¯æ•°æ®: ${JSON.stringify(err.data)}`, 'error');
                    }
                    
                    log('\næ–¹æ³• 2: å°è¯•ä¸åŒçš„ç¼–ç æ–¹å¼...', 'warning');
                    
                    // ç®€åŒ–ç‰ˆæœ¬
                    const data2 = '0xd06ca61f' +
                        '0000000000000000000000000000000000000000000000000000000005f5e100' + // 1 BTC
                        '0000000000000000000000000000000000000000000000000000000000000040' +
                        '0000000000000000000000000000000000000000000000000000000000000002' +
                        '0000000000000000000000005eaa2c6ae3bff47d2188b64f743ec777733a80ac' +
                        '000000000000000000000000934ebeb6d7d3821b604a5d10f80619d5bcbe49c3';
                    
                    try {
                        const result2 = await window.ethereum.request({
                            method: 'eth_call',
                            params: [{ to: ROUTER, data: data2 }, 'latest']
                        });
                        log(`   âœ… æ–¹æ³•2æˆåŠŸ! è¿”å›: ${result2.substring(0, 100)}...`, 'success');
                        return true;
                    } catch (err2) {
                        log(`   âŒ æ–¹æ³•2ä¹Ÿå¤±è´¥: ${err2.message}\n`, 'error');
                        return false;
                    }
                }
            } catch (err) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}\n`, 'error');
                return false;
            }
        }
        
        async function test4() {
            log('=== æµ‹è¯• 4: addLiquidity (ä»…ä¼°ç®— gas) ===\n', 'info');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const account = accounts[0];
                
                const amountA = 1n * 10n**8n;  // 1 BTC
                const amountB = 5n * 10n**18n; // 5 ETH
                const minA = amountA * 95n / 100n;
                const minB = amountB * 95n / 100n;
                const deadline = Math.floor(Date.now() / 1000) + 1200;
                
                const data = '0xe8e33700' +
                    BTC.slice(2).padStart(64, '0') +
                    ETH.slice(2).padStart(64, '0') +
                    amountA.toString(16).padStart(64, '0') +
                    amountB.toString(16).padStart(64, '0') +
                    minA.toString(16).padStart(64, '0') +
                    minB.toString(16).padStart(64, '0') +
                    account.slice(2).padStart(64, '0') +
                    deadline.toString(16).padStart(64, '0');
                
                log(`è°ƒç”¨æ•°æ®é•¿åº¦: ${data.length} å­—ç¬¦`, 'info');
                log(`å‚æ•°:`, 'info');
                log(`  tokenA: ${BTC}`, 'info');
                log(`  tokenB: ${ETH}`, 'info');
                log(`  amountA: ${amountA} (${Number(amountA) / 1e8} BTC)`, 'info');
                log(`  amountB: ${amountB} (${Number(amountB) / 1e18} ETH)`, 'info');
                log(`  to: ${account}\n`, 'info');
                
                try {
                    const gasEstimate = await window.ethereum.request({
                        method: 'eth_estimateGas',
                        params: [{
                            from: account,
                            to: ROUTER,
                            data: data
                        }]
                    });
                    log(`âœ… Gas ä¼°ç®—æˆåŠŸ: ${parseInt(gasEstimate, 16)}\n`, 'success');
                    return true;
                } catch (err) {
                    log(`âŒ Gas ä¼°ç®—å¤±è´¥: ${err.message}`, 'error');
                    
                    if (err.data && err.data.message) {
                        log(`   è¯¦ç»†é”™è¯¯: ${err.data.message}`, 'error');
                    }
                    
                    // å°è¯• eth_call çœ‹çœ‹è¿”å›ä»€ä¹ˆ
                    log('\nå°è¯• eth_call...', 'warning');
                    try {
                        const callResult = await window.ethereum.request({
                            method: 'eth_call',
                            params: [{
                                from: account,
                                to: ROUTER,
                                data: data
                            }, 'latest']
                        });
                        log(`   eth_call è¿”å›: ${callResult}`, 'info');
                    } catch (callErr) {
                        log(`   eth_call ä¹Ÿå¤±è´¥: ${callErr.message}\n`, 'error');
                    }
                    
                    return false;
                }
            } catch (err) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}\n`, 'error');
                return false;
            }
        }
        
        async function test5() {
            log('=== æµ‹è¯• 5: å¯¹æ¯” Pair ç›´æ¥è°ƒç”¨ ===\n', 'info');
            
            try {
                // é€šè¿‡ Pair è·å–å‚¨å¤‡é‡
                log('é€šè¿‡ Pair.getReserves()...', 'info');
                const reservesData = '0x0902f1ac';
                const reservesResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: PAIR, data: reservesData }, 'latest']
                });
                
                const reserve0 = BigInt('0x' + reservesResult.slice(2, 66));
                const reserve1 = BigInt('0x' + reservesResult.slice(66, 130));
                
                log(`   Reserve0: ${reserve0} (${Number(reserve0) / 1e8} BTC)`, 'success');
                log(`   Reserve1: ${reserve1} (${Number(reserve1) / 1e18} ETH)`, 'success');
                
                // æ‰‹åŠ¨è®¡ç®— amountOut
                const amountIn = 1n * 10n**8n;
                const amountInWithFee = amountIn * 997n;
                const numerator = amountInWithFee * reserve1;
                const denominator = reserve0 * 1000n + amountInWithFee;
                const amountOut = numerator / denominator;
                
                log(`\næ‰‹åŠ¨è®¡ç®— (Uniswap V2 å…¬å¼):`, 'info');
                log(`   è¾“å…¥: ${Number(amountIn) / 1e8} BTC`, 'info');
                log(`   è¾“å‡º: ${Number(amountOut) / 1e18} ETH`, 'success');
                
                log('\nâœ… Pair åˆçº¦å·¥ä½œæ­£å¸¸\n', 'success');
                return true;
            } catch (err) {
                log(`âŒ é”™è¯¯: ${err.message}\n`, 'error');
                return false;
            }
        }
        
        async function runAll() {
            clearOutput();
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­...\n\n', 'info');
            
            const results = [];
            results.push(await test1());
            results.push(await test2());
            results.push(await test3());
            results.push(await test4());
            results.push(await test5());
            
            log('='.repeat(60), 'info');
            log('\nğŸ“Š è¯Šæ–­æ€»ç»“:\n', 'info');
            log(`æµ‹è¯• 1 (åŸºç¡€é…ç½®): ${results[0] ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, results[0] ? 'success' : 'error');
            log(`æµ‹è¯• 2 (ç®€å•å‡½æ•°): ${results[1] ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, results[1] ? 'success' : 'error');
            log(`æµ‹è¯• 3 (getAmountsOut): ${results[2] ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, results[2] ? 'success' : 'error');
            log(`æµ‹è¯• 4 (addLiquidity): ${results[3] ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, results[3] ? 'success' : 'error');
            log(`æµ‹è¯• 5 (Pair å¯¹æ¯”): ${results[4] ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, results[4] ? 'success' : 'error');
            
            const passCount = results.filter(r => r).length;
            log(`\né€šè¿‡ç‡: ${passCount}/5`, passCount === 5 ? 'success' : 'warning');
            log('='.repeat(60), 'info');
        }
    </script>
</body>
</html>
