<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿè¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        pre {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #3e3e42;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1177bb; }
    </style>
</head>
<body>
    <h1>ğŸ” Swap å¿«é€Ÿè¯Šæ–­</h1>
    <button onclick="runDiagnosis()">è¿è¡Œè¯Šæ–­</button>
    <pre id="output"></pre>

    <script>
        const CONFIG = {
            chainId: 1281,
            factory: '0xf0616CCDa274b6DbFa645d70f8Dc0f617707E793',
            wdev: '0xFA3956c0620488E2ccdfc48BB02baeB8BDa286fC',
            eth: '0x934EbeB6D7D3821B604A5D10F80619d5bcBe49C3',
            multicall: '0xF396bb272c5f11EF5E172bAEEC49e9cC895c589a'
        };

        async function runDiagnosis() {
            const output = document.getElementById('output');
            output.textContent = 'å¼€å§‹è¯Šæ–­...\n\n';

            try {
                // æ£€æŸ¥ MetaMask
                if (typeof window.ethereum === 'undefined') {
                    output.textContent += 'âŒ è¯·å…ˆè¿æ¥ MetaMask é’±åŒ…\n';
                    return;
                }

                // æ£€æŸ¥ Chain ID
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdInt = parseInt(chainId, 16);
                output.textContent += `Chain ID: ${chainIdInt} ${chainIdInt === CONFIG.chainId ? 'âœ…' : 'âŒ'}\n\n`;

                if (chainIdInt !== CONFIG.chainId) {
                    output.textContent += 'âŒ è¯·åˆ‡æ¢åˆ° NBC é“¾ (1281)\n';
                    return;
                }

                // æ£€æŸ¥äº¤æ˜“å¯¹æ˜¯å¦å­˜åœ¨
                output.textContent += '=== æ£€æŸ¥äº¤æ˜“å¯¹ ===\n';
                const factoryABI = ['function getPair(address tokenA, address tokenB) external view returns (address pair)'];
                const getPairData = '0xe6a43905' + 
                    CONFIG.wdev.slice(2).padStart(64, '0') +
                    CONFIG.eth.slice(2).padStart(64, '0');

                const pairResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: CONFIG.factory, data: getPairData }, 'latest']
                });

                const pairAddress = '0x' + pairResult.slice(-40);
                output.textContent += `äº¤æ˜“å¯¹åœ°å€: ${pairAddress}\n`;

                if (pairAddress === '0x0000000000000000000000000000000000000000') {
                    output.textContent += 'âŒ äº¤æ˜“å¯¹ä¸å­˜åœ¨ï¼è¯·å…ˆåˆ›å»ºæµåŠ¨æ€§æ± \n';
                    return;
                }
                output.textContent += 'âœ… äº¤æ˜“å¯¹å­˜åœ¨\n\n';

                // æ£€æŸ¥ Reserves
                output.textContent += '=== æ£€æŸ¥ Reserves ===\n';
                const pairABI = ['function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)'];
                const getReservesData = '0x0902f1ac';
                
                const reservesResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: pairAddress, data: getReservesData }, 'latest']
                });

                // è§£æç»“æœ (uint112, uint112, uint32)
                const reserve0Hex = '0x' + reservesResult.slice(2, 66);
                const reserve1Hex = '0x' + reservesResult.slice(66, 130);
                
                const reserve0 = BigInt(reserve0Hex);
                const reserve1 = BigInt(reserve1Hex);
                
                const reserve0Formatted = Number(reserve0) / 1e18;
                const reserve1Formatted = Number(reserve1) / 1e18;

                output.textContent += `Reserve0: ${reserve0Formatted.toFixed(6)}\n`;
                output.textContent += `Reserve1: ${reserve1Formatted.toFixed(6)}\n`;

                if (reserve0 === 0n && reserve1 === 0n) {
                    output.textContent += 'âŒ Reserves ä¸º 0ï¼ŒæµåŠ¨æ€§æ± ä¸ºç©º\n';
                } else {
                    output.textContent += 'âœ… Reserves æ­£å¸¸\n\n';
                }

                // æ£€æŸ¥ Multicall
                output.textContent += '=== æ£€æŸ¥ Multicall ===\n';
                output.textContent += `Multicall åœ°å€: ${CONFIG.multicall}\n`;
                
                // æ£€æŸ¥ Multicall åˆçº¦ä»£ç 
                const multicallCode = await window.ethereum.request({
                    method: 'eth_getCode',
                    params: [CONFIG.multicall, 'latest']
                });

                if (multicallCode === '0x' || multicallCode === '0x0') {
                    output.textContent += 'âŒ Multicall åˆçº¦ä¸å­˜åœ¨\n';
                } else {
                    output.textContent += `âœ… Multicall åˆçº¦å­˜åœ¨ (${multicallCode.length} å­—èŠ‚)\n\n`;
                }

                // æ€»ç»“
                output.textContent += '=== è¯Šæ–­æ€»ç»“ ===\n';
                if (pairAddress !== '0x0000000000000000000000000000000000000000' && 
                    reserve0 > 0n && reserve1 > 0n) {
                    output.textContent += 'âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼\n';
                    output.textContent += 'å¦‚æœ Swap é¡µé¢ä»æ— æ³•è®¡ç®—ï¼Œå¯èƒ½æ˜¯ï¼š\n';
                    output.textContent += '1. æµè§ˆå™¨ç¼“å­˜é—®é¢˜ - å°è¯•ç¡¬åˆ·æ–° (Ctrl+Shift+R)\n';
                    output.textContent += '2. React çŠ¶æ€æœªæ›´æ–° - ç­‰å¾…å‡ ç§’æˆ–åˆ‡æ¢ä»£å¸\n';
                    output.textContent += '3. Multicall æ•°æ®æœªåŒæ­¥ - ç­‰å¾… 5-10 ç§’\n';
                } else {
                    output.textContent += 'âŒ å‘ç°é—®é¢˜ï¼Œè¯·æ ¹æ®ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ä¿®å¤\n';
                }

            } catch (error) {
                output.textContent += `\nâŒ é”™è¯¯: ${error.message}\n`;
                console.error(error);
            }
        }

        // è‡ªåŠ¨è¿è¡Œ
        window.onload = function() {
            if (typeof window.ethereum !== 'undefined') {
                runDiagnosis();
            }
        };
    </script>
</body>
</html>
